```{r, echo=FALSE, message=FALSE}
library(knitr)
library(readxl)
library(lubridate)
library(stringr)
library(tidyverse)
library(here)
```

```{r}
deaths <- read_xlsx(here("data/raw_data/AIDSVu_State_Death_2020.xlsx"), skip = 3)
late_dx <- read_xlsx(here("data/raw_data/AIDSVu_State_LateDiagnoses_2020.xlsx"), skip = 3)
us_race <- read_xlsx(here("data/raw_data/DECENNIALPL2020.P2-2023-02-24T124235.xlsx"), sheet = 2)
us_sex <-read_csv(here("data/raw_data/raw_data.csv"), skip = 2)

new_dx <- read_xlsx(here("data/raw_data/AIDSVu_State_NewDX_2020.xlsx"), skip = 3)
prev  <- read_xlsx(here("data/raw_data/AIDSVu_State_Prev_2020.xlsx"), skip = 3)
rec_care  <- read_xlsx(here("data/raw_data/AIDSVu_State_ReceiptofCare_2020.xlsx"), skip = 3)
sdoh  <- read_xlsx(here("data/raw_data/AIDSVu_State_SDOH_2020.xlsx"), skip = 3)
v_sup  <- read_xlsx(here("data/raw_data/AIDSVu_State_ViralSuppression_2020.xlsx"), skip = 3)
``

let's start by separating `deaths` by demographic characteristic . While this data provides information on demographic characteristics such as sex, age group, and race/ethnicity, it does not provide data on all of these terms together. We'll separating by sex and race/ethnicity. This analysis will be limited to Non-Hispanic Black, Non-Hispanic White, and Hispanic persons.
```{r}
deaths_sex <- deaths %>% select(1:4, contains(c("male", "MSM")))

deaths_race <-   deaths %>% select(1:4, contains(c("Black", "White", "Hispanic",  "Multiple")))

summary(deaths_race)
```
Some rates are -9 due to there not being data for these observations. Let's convert these to NA
```{r}
death_race <-deaths_race %>% 
  mutate(across(ends_with("Death Rate"), ~ case_when( .x < 0 ~ NA, TRUE ~ .x)))
```

Next let's move on to the census data. I'll start by re-formatting the data from wide format for States to long, and format race/ethnicity into wide.
```{r}
glimpse(us_race)

race <- us_race %>%  
  pivot_longer(2:54 , names_to = "Location", values_to = "Population" ) %>%  
  pivot_wider(names_from = Label, values_from= Population)
```

```{r}
race <- race %>% 
  select(c(Location, starts_with(c("Total:", "Black or African American alone", "Hispanic", "White alone", "Population of two or more races:")))) %>% 
  rename(c(Hispanic = `Hispanic or Latino`,
         White = `White alone`,
         Black = `Black or African American alone`,
         Multiple = `Population of two or more races:`))
```

Then, I'll use inner join to merge the dataset contain percentage make up by sex for each state. 
```{r}
pop <- inner_join(us_sex, race) %>%
  select(!Total) 
```

I need to remove all commas from the dataframe and convert the columns to numeric. 
```{r}
pop <- pop %>% 
  mutate_all(~ str_remove_all(., ",")) %>% 
  mutate(across(2:8, ~ as.numeric(.)))
```

Then, I'll calculate the counts of males and females in each location.
```{r}
pop <- pop %>% 
  mutate(Male = Male * `Total:`) %>% 
  mutate(Female = Female * `Total:`)
```

```{r}
pop_sex <- pop %>%  select(1:3)

sex_df <- inner_join(deaths_sex, pop_sex, by = join_by("State" == Location))
```

```{r}
sex_df %>% mutate(m_rate = (`Male Death Cases` * Male)*1e5)

```

https://datacenter.kidscount.org/data/tables/101-child-population-by-age-group#detailed/2/2-53/false/574/62,63,64,6,4693/419

We need to estimate the population older than 13. We can get pretty close with the data above. 

```{r}
kid_pop <- read_xlsx(here("data/Child population by age group.xlsx"))
kid_pop <- kid_pop %>%  filter(TimeFrame == 2020)
```

 Most recent known address was used in all analyses except for new HIV diagnoses, late diagnoses, and linkage to care, which are calculated based on residence at diagnosis. Denominators used to calculate rates for all state and county populations were obtained by CDC from the U.S. Census Bureauâ€™s census for each respective year. Population denominators are restricted to people aged 13 and older. There are no county-level maps for the District of Columbia because there are no counties in DC.

HIV surveillance data are displayed as case counts, rates, and/or proportions (represented as % cases). Rates were calculated per 100,000 population to permit data standardization and comparison. For rate ratios by race/ethnicity displayed on state profile pages, White race is the referent group.
